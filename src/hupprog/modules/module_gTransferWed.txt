Option Compare Database
Option Explicit

Private Function lenCheckProgrammanummers() As Boolean
On Error GoTo fout
lenCheckProgrammanummers = False

Dim impProg As Recordset
Set impProg = CurrentDb().OpenRecordset("select * from gIMP_LEN_programma where( nz( [imp_import] ) = true ) and ( nz([aux_wedstrijdnummer]) > 0 ) order by nz([aux_wedstrijdnummer]), nz([corr_programmanummer]) ;")


Dim lastWednr As Long
Dim lastProg As String
lastProg = ""
lastWednr = -1

impProg.MoveFirst
Do Until impProg.EOF
  Dim wednr As Long
  Dim prognr As String
  wednr = Nz(impProg("AUX_Wedstrijdnummer"))
  prognr = Nz(impProg("CORR_Programmanummer"))
  
  If (wednr = lastWednr And lastProg = prognr) Then
    Err.Raise 1, , "Dubbel programmanr gevonden: " & wednr & "," & prognr
  End If
  
  lastWednr = wednr
  lastProg = prognr

  impProg.MoveNext
Loop


appCleanRS impProg


lenCheckProgrammanummers = True
Exit Function
fout:
If (Err = 3021) Then Resume Next
MsgBox Err & " " & Error$, 16

Exit Function

'debug
'On Error GoTo 0
'Resume


Exit Function
End Function




Public Function lenIntFinishImportSequence(ByRef blErrorRecoverable As Boolean) As Boolean
On Error GoTo fout
lenIntFinishImportSequence = False

Dim wrkSpace  As Workspace

'Set wrkSpace = DBEngine.Workspaces(0)
'wrkSpace.BeginTrans

If (lenIntFinishImportSequence_perform(blErrorRecoverable)) Then
  'wrkSpace.CommitTrans
Else
  'wrkSpace.Rollback
  Exit Function
End If
    


'Set wrkSpace = Nothing

lenIntFinishImportSequence = True
Exit Function
fout:
MsgBox Err & " " & Error$, 16
Exit Function
End Function

Private Function lenIntFinishImportSequence_perform(ByRef blErrRecoverable As Boolean) As Boolean
On Error GoTo fout
lenIntFinishImportSequence_perform = False


'Initial preparation

blErrRecoverable = False


'Mark that we will not be importing weds & clubs that belong to time archives or records
Dim sql As String

DoCmd.SetWarnings False

sql = "update gIMP_LEN_Wedstrijden set IMP_Import = false where we_partOfTimeArchive;"
DoCmd.RunSQL sql

sql = "update gIMP_LEN_Ver set IMP_Import = false where (V_partOfTimeArchive or V_partOfRecord);"
DoCmd.RunSQL sql


DoCmd.SetWarnings True


'Repair phase:
'Work with user to repair issues

blErrRecoverable = True

If Not trfRepairInvalidStartnummers() Then
  Exit Function
End If

If Not trfRepairDuplicateStartnummers(False) Then
  Exit Function
End If


'First check to see if there are any problematic programmanummers.

blErrRecoverable = True

If Not lenCheckUnmatchableProgrammanummers() Then Exit Function

If Not lenCheckLftProblemProgrammanummers() Then Exit Function

blErrRecoverable = False


If Not lnhProcessUserImportSettings() Then Exit Function

If Not lenFillAuxFields() Then Exit Function

'now need to test if everything is OK.

blErrRecoverable = True

If Not lenCheckDepotnummers() Then Exit Function

If Not lenCheckProgrammanummers() Then Exit Function

If Not lenCheckBlockedZwemmers() Then Exit Function

If Not lenCheckTransferTimes() Then Exit Function

blErrRecoverable = False

Dim nNewWeds As Integer, nNewProgs As Integer, newWedMinNr As Long, nNewSwimmers As Long



If Not lnhImportWedstrijd(nNewWeds, newWedMinNr, nNewProgs, nNewSwimmers) Then
  Exit Function
End If



Dim lnhTransferdata As LNH_TRANSFER_DATA

If Not lnhTransferTimes_Init(lnhTransferdata) Then
  Exit Function
End If


If Not lenFinishImportTransferTimes(lnhTransferdata) Then
  Exit Function
End If


'Show some statistics and query user if he wants to keep the changes
If Not lenFinishImportShowStats(lnhTransferdata, nNewWeds, nNewProgs, newWedMinNr, nNewSwimmers) Then
  Exit Function
End If




If Not lnhTransferTimes_Clean(lnhTransferdata) Then
  Exit Function
End If


lenIntFinishImportSequence_perform = True
Exit Function
fout:
MsgBox Err & " lenIntFinishImportSequence_perform" & vbCrLf & Error$, 16
End Function


Private Function lenFinishImportTransferTimes(ByRef lnhTransferdata As LNH_TRANSFER_DATA) As Boolean
lenFinishImportTransferTimes = lenFinishTransferTimes_perform(False, False, lnhTransferdata)
End Function



Private Function lenFinishImportShowStats(ByRef lnhTransferdata As LNH_TRANSFER_DATA, ByVal nNewWeds As Integer, ByVal nNewProgs As Integer, ByVal newWedMinNr As Long, ByVal nNewSwimmer As Long) As Boolean
On Error GoTo fout

lenFinishImportShowStats = False

Dim wedS As Recordset
Set wedS = CurrentDb().OpenRecordset("gIMP_LEN_WEDSTRIJDEN")

Dim inpCnt As Long
inpCnt = 0


wedS.MoveFirst
Do Until wedS.EOF
  If (Nz(wedS("IMP_IMPORT"))) Then
    inpCnt = inpCnt + 1
  End If
  
  wedS.MoveNext
Loop

appCleanRS wedS

Dim lxImpStats As LX_IMP_STATS

lxImpStats.nImpWed = inpCnt
lxImpStats.newWedMinNr = newWedMinNr
lxImpStats.nNewProgs = nNewProgs
lxImpStats.nNewSwimmer = nNewSwimmer
lxImpStats.nNewWeds = nNewWeds

If Not lnhDisplaySuccessMessage(lnhTransferdata, lxImpStats) Then
 Exit Function
End If




lenFinishImportShowStats = True
Exit Function
fout:
If (Err = 3021) Then Resume Next ' no current record

appCleanRS wedS

MsgBox Err & " " & Error$, 16
Exit Function
End Function



Private Function lenFinishTransferTimes_perform(ByVal blIsCheck As Boolean, ByRef blCheckFailed As Boolean, ByRef lnhTransferdata As LNH_TRANSFER_DATA) As Boolean
On Error GoTo fout
lenFinishTransferTimes_perform = False

blCheckFailed = False



Dim blTransferTimes As Boolean
blTransferTimes = Nz(DLookup("IMP_VerwerkTijden", "gIMP_LEN_Options"), False)

Dim blImpTimes As Boolean
blImpTimes = Nz(DLookup("IMP_Tijden", "gImp_LEN_Options"))


If (blTransferTimes And blImpTimes) Then
  'Need to get the wedstrijden for which times have been imported.
  Dim sql As String
  sql = "SELECT gIMP_LEN_Tijden.AUX_Wedstrijdnummer FROM gIMP_LEN_Tijden " & _
        "WHERE (((Nz([AUX_Programmanummer])) <> """") And ((Nz([AUX_Depotnummer])) <> """") " & _
        "And ((Nz([AUX_Wedstrijdnummer])) > 0)) GROUP BY gIMP_LEN_Tijden.AUX_Wedstrijdnummer;"

  Dim rs As Recordset
  Set rs = CurrentDb().OpenRecordset(sql)
  rs.MoveFirst
  Do Until rs.EOF
    Dim tpWed As Long
    tpWed = Nz(rs("AUX_Wedstrijdnummer"))
    
    If (blIsCheck) Then
      Dim tpCannotProcess As Boolean
      tpCannotProcess = False
      If Not lnhTransferTimes_checkWed(tpWed, tpCannotProcess) Then
        Exit Function
      End If
      If (tpCannotProcess) Then
        blCheckFailed = True
      End If
    Else
    
      If Not lnhTransferTimes_processWed(lnhTransferdata, tpWed) Then
        Exit Function
      End If
    End If
    
    rs.MoveNext
  Loop
  appCleanRS rs
End If


lenFinishTransferTimes_perform = True
Exit Function

fout:
If (Err = 3021) Then Resume Next
MsgBox Err & " lenFinishTransferTimes_perform" & vbCrLf & Error$, 16
Exit Function

End Function


Private Function lenCheckTransferTimes() As Boolean
On Error GoTo fout
lenCheckTransferTimes = False

Dim tpCheckFailed As Boolean, lnhDummy As LNH_TRANSFER_DATA
If Not lenFinishTransferTimes_perform(True, tpCheckFailed, lnhDummy) Then
  Exit Function
End If


If (tpCheckFailed) Then

  'Have to ask whether to continue.
  Dim msg As String
  
  msg = "Voor een of meerdere van de te importeren wedstrijden staan er in de hoofdadministratie al tijden geregistreerd." & vbCrLf & _
  "Voor deze wedstrijden zal de optie <Tijden verwerken> niet worden uitgevoerd." & vbCrLf & _
  "Wilt u desondanks doorgaan met importeren?"
  
  If (MsgBox(msg, vbExclamation + vbYesNo + vbDefaultButton2) = vbNo) Then
    Exit Function
  End If
End If



lenCheckTransferTimes = True
Exit Function
fout:
MsgBox Err & " lenCheckTransferTimes" & vbCrLf & Error$, 16
Exit Function
End Function




Private Function lenCheckLftProblemProgrammanummers() As Boolean
On Error GoTo fout
lenCheckLftProblemProgrammanummers = False

'The tactic will be to look for programmanummers met IMP_Import = true en IMP_blLftProblem = true.
'These programmanummers have a leeftijdsgroep problem

Dim progs As Recordset
Dim sql As String
sql = "select * from gIMP_LEN_Programma where (nz([IMP_Import],false) = true and nz([imp_blLftProblem],false) = true ) order by val(nz([pr_programmanummer]));"
Set progs = CurrentDb().OpenRecordset(sql)


Dim nProbs  As Integer
nProbs = 0
Dim sProbs As String
sProbs = ""

progs.MoveFirst
Do Until progs.EOF
  nProbs = nProbs + 1
  If (Len(sProbs) > 0) Then
    sProbs = sProbs + ", "
  End If
  sProbs = sProbs & Nz(progs("PR_Programmanummer"))
  progs.MoveNext
Loop


appCleanRS progs



If (nProbs > 0) Then
  'Have to ask whether to continue.
  Dim msg As String
  
  msg = "Er zijn " & nProbs & " programmanummers die een probleem met de leeftijdsgroep hebben." & Chr(13) & _
  "Dit zijn de prognrs " & sProbs & "." & vbCrLf & _
  "De minimale en/of maximale leeftijden van deze programmanummers vertonen een afwijking." & vbCrLf & _
  "U wordt aangeraden om NIET verder te gaan met importeren voordat u hebt uitgezocht waar deze verschillen vandaan komen." & vbCrLf & _
  "Wilt u doorgaan met importeren?"
  
  If (MsgBox(msg, vbExclamation + vbYesNo + vbDefaultButton2) = vbNo) Then
    Exit Function
  End If
End If


lenCheckLftProblemProgrammanummers = True
Exit Function
fout:
If (Err = 3021) Then Resume Next ' no current record.
MsgBox Err & " lenCheckLftProblemProgrammanummers" & vbCrLf & Error$, 16
Exit Function
End Function



Private Function lenCheckUnmatchableProgrammanummers() As Boolean
On Error GoTo fout
lenCheckUnmatchableProgrammanummers = False

'The tactic will be to look for programmanummers met IMP_Import = true en IMP_Programmanummer = null.
'These programmanummers could not be matched!

Dim progs As Recordset
Dim sql As String
sql = "select * from gIMP_LEN_Programma where (nz([IMP_Import],false) = true and nz([imp_programmanummer]) = """" ) order by val(nz([pr_programmanummer]));"
Set progs = CurrentDb().OpenRecordset(sql)


Dim nUnmatchable  As Integer
nUnmatchable = 0
Dim sUnmatchable As String
sUnmatchable = ""

progs.MoveFirst
Do Until progs.EOF
  nUnmatchable = nUnmatchable + 1
  If (Len(sUnmatchable) > 0) Then
    sUnmatchable = sUnmatchable + ", "
  End If
  sUnmatchable = sUnmatchable & Nz(progs("PR_Programmanummer"))
  progs.MoveNext
Loop


appCleanRS progs



If (nUnmatchable > 0) Then
  'Have to ask whether to continue.
  Dim msg As String
  
  msg = "Er zijn " & nUnmatchable & " programmanummers die niet zonder meer verwerkt konden worden." & Chr(13) & _
  "Dit zijn de prognrs " & sUnmatchable & "." & vbCrLf & _
  "Oorzaken kunnen zijn dat afstand/slag niet overeenkomen met de programmanummers die nu al in de wedstrijd aanwezig zijn." & vbCrLf & _
  "Als u nu doorgaat, zullen deze " & nUnmatchable & " programmanummer(s) worden toegevoegd met een nieuw nummer." & vbCrLf & _
  "Aangeraden wordt om nu NIET door te gaan met importeren, maar eerst in het wizardscherm met programmanummers te kijken wat er precies mis gaat." & vbCrLf & _
  "Wilt u doorgaan?"
  
  If (MsgBox(msg, vbExclamation + vbYesNo + vbDefaultButton2) = vbNo) Then
    Exit Function
  End If
End If


lenCheckUnmatchableProgrammanummers = True
Exit Function
fout:
If (Err = 3021) Then Resume Next ' no current record.
MsgBox Err & " " & Error$, 16
Exit Function
End Function





Public Function lenHandleCompleteMMImpSequence(splFDir As String, splFName As String, wedIsOpen As Boolean, curOpenWedNr As Long, curOpenWedDate As Date, curOpenWedTime As Date, openWedIsMeet As Boolean, openWedMeetNr As Long) As Boolean
On Error GoTo fout
lenHandleCompleteMMImpSequence = False

Dim splFCompleteName As String
splFCompleteName = directory_goedmaak(splFDir) & "\" & splFName

'Clean up the transfer tables.
If Not lenCleanTransferTables() Then
  Exit Function
End If

'Read the file
If Not splMMImpFillLenTransTables(splFCompleteName) Then
  Exit Function
End If


Dim glbWedDate As Date, glbWedLftMode As String

If Not lnhImportGenerateDefaultImportSettings(glbWedDate, glbWedLftMode, wedIsOpen, curOpenWedNr, curOpenWedDate, curOpenWedTime, openWedIsMeet, openWedMeetNr) Then Exit Function

If Not lnhImportGenerateDefaultProgImportSettings(glbWedDate, glbWedLftMode) Then Exit Function


'Now open the wizard.
DoCmd.OpenForm "hxIMP_LEN_MASTER", acNormal, , , , acDialog

lenHandleCompleteMMImpSequence = True
Exit Function
fout:
MsgBox Err & " " & Error$, 16
Exit Function
End Function


Public Function lenHandleCompleteWasImpSequence(wasFDir As String, wasFName As String, wedIsOpen As Boolean, curOpenWedNr As Long, curOpenWedDate As Date, curOpenWedTime As Date, openWedIsMeet As Boolean, openWedMeetNr As Long) As Boolean
On Error GoTo fout
lenHandleCompleteWasImpSequence = False

Dim wasFCompleteName As String
wasFCompleteName = directory_goedmaak(wasFDir) & "\" & wasFName

If Not wedIsOpen Then
  Err.Raise 1, , "There must be an open wedstrijd nummer for this option to be supported."
End If

'Clean up the transfer tables.
If Not lenCleanTransferTables() Then
  Exit Function
End If

'Read the file
If Not wasImpFillLenTransTables(wasFCompleteName, curOpenWedNr, False, #1/1/1900#) Then
  Exit Function
End If


Dim glbWedDate As Date, glbWedLftMode As String

If Not lnhImportGenerateDefaultImportSettings(glbWedDate, glbWedLftMode, wedIsOpen, curOpenWedNr, curOpenWedDate, curOpenWedTime, openWedIsMeet, openWedMeetNr) Then Exit Function

If Not lnhImportGenerateDefaultProgImportSettings(glbWedDate, glbWedLftMode) Then Exit Function


'Now open the wizard.
DoCmd.OpenForm "hxIMP_LEN_MASTER", acNormal, , , , acDialog

lenHandleCompleteWasImpSequence = True
Exit Function
fout:
MsgBox Err & " lenHandleCompleteWasImpSequence" & vbCrLf & Error$, 16
Exit Function
End Function